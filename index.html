<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stokvel Escrow — Coxygen Global</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=League+Spartan:wght@100..900&display=swap');

body {
    margin: 0;
    font-family: 'League Spartan', sans-serif;
    background-color: #0b1a2f;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

.main-container {
    width: 100%;
    max-width: 700px;
    padding: 24px;
    background: linear-gradient(145deg, #0d254d, #071028);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.container img {
    display: block;
    margin: 0 auto 16px auto;
    width: 120px;
}

.balance-card {
    background-color: rgba(255,255,255,0.05);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
    text-align: center;
}

.balance-card h1 {
    margin: 0 0 8px 0;
    font-size: 24px;
    color: #00c6ff;
}

.league-spartan-regular {
    font-weight: 500;
    font-size: 16px;
    margin-bottom: 4px;
}

.input-group {
    margin-bottom: 12px;
}

.input-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
}

.input-icon-group input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background-color: rgba(255,255,255,0.08);
    color: #fff;
    font-size: 14px;
}

.button-group {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}

.send-button {
    flex: 1;
    background: linear-gradient(90deg,#00c6ff,#0072ff);
    border: none;
    border-radius: 8px;
    padding: 12px;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
}

.reset-button {
    flex: 1;
    background-color: rgba(255,255,255,0.08);
    border: none;
    border-radius: 8px;
    padding: 12px;
    color: #ddd;
    font-weight: 700;
    cursor: pointer;
}

.wallet-status {
    margin-bottom: 16px;
    font-size: 14px;
    text-align: center;
    color: #00c6ff;
    font-weight: 600;
}

.connect-wallet-btn {
    display: block;
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    background-color: #00c6ff;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 16px;
}

.terms {
    margin-top: 20px;
    font-size: 12px;
    text-align: center;
    color: #888;
}
</style>

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<script type="module">
import{
    bytesToHex,Cip30Wallet,WalletHelper,TxOutput,
    Assets,bytesToText,hexToBytes,AssetClass,
    Tx,Address, NetworkParams, Value,MintingPolicyHash,
    Program,ByteArrayData,ConstrData,NetworkEmulator,PubKey,
    textToBytes,Datum,ListData,IntData
} from "./js/helios.js";

import{
    txPrerequisites,init,walletEssentials,txFunc,hlib,hexToTex,shortAddressFunc, 
    addressFunc, adaFunc, assetFunc,getAssets,sendADA,sendAssets,
    showWalletData,mint,txDeadLine,baseAddressPKH,submitTx, getAssetsFromValue
} from "./js/coxylib.js";

import{opt,j} from "./js/jimba.js";

opt._R = 1;
opt._O = 1;
opt._M = 1;
opt._T = 1;
opt._Ob = 0;
opt._FailsOnly = 0;
opt._F = 0;
opt._tNo = 1;

const domGetId = id => document.getElementById(id);

let walletData = null;

// Connect Wallet
domGetId("connectWallet").addEventListener("click", async () => {
    try {
        const wallet = await init(j);
        walletData = await walletEssentials(wallet, Cip30Wallet, WalletHelper, Value, txPrerequisites.minAda, j);
        j.log({walletData});

        // Display balance
        const displayLovelace = await adaFunc(walletData, j);
        const displayAda = (displayLovelace / 1_000_000).toLocaleString();
        domGetId("adaBalance").innerText = "₳ " + displayAda;
        domGetId("walletStatus").innerText = "Wallet Connected ✅";

    } catch (err) {
        console.error("Wallet connection failed:", err);
        swal("Wallet Error", "Could not connect wallet. Make sure wallet is installed and on Preprod (testnet).", "error");
        domGetId("walletStatus").innerText = "Wallet Not Connected ❌";
    }
});

// Send ADA
domGetId("sendAdaForm").addEventListener("submit", async (event) => {
    event.preventDefault();

    if(!walletData){
        swal("Wallet not connected", "Please connect your wallet first.", "warning");
        return;
    }

    const recipientAddress = domGetId("recipient").value.trim();
    const adaAmountRaw = domGetId("amount").value.trim();
    const adaAmount = Number(adaAmountRaw);

    if(!recipientAddress){
        swal("Missing address", "Please enter recipient address.", "warning");
        return;
    }
    if(!adaAmountRaw || isNaN(adaAmount) || adaAmount <= 0){
        swal("Invalid amount", "Enter a valid amount of ADA.", "warning");
        return;
    }

    try {
        const result = await sendADA(recipientAddress, adaAmount);
        const txHash = typeof result === "string" ? result : (result?.txHash || result?.hash || "unknown");
        swal("Success", `₳${adaAmount} sent!\nTx: ${txHash}`, "success");
        domGetId("sendAdaForm").reset();

        // Update balance
        const displayLovelace = await adaFunc(walletData, j);
        const displayAda = (displayLovelace / 1_000_000).toLocaleString();
        domGetId("adaBalance").innerText = "₳ " + displayAda;

    } catch (err) {
        console.error(err);
        swal("Transaction Failed", err?.message || "Error sending ADA", "error");
    }
});

// Clear Form
domGetId("clearForm").addEventListener("click", (e)=>{
    e.preventDefault();
    domGetId("sendAdaForm").reset();
});
</script>
</head>

<body>
<div class="main-container">
    <div class="container">
        <img src="./images/coxygen.png" alt="Coxygen logo">
        <div class="balance-card">
            <h1>Stokvel Escrow ADA Transfer</h1>
        </div>
    </div>

    <!-- Connect Wallet -->
    <button id="connectWallet" class="connect-wallet-btn">Connect Wallet</button>
    <div class="wallet-status" id="walletStatus">Wallet Not Connected ❌</div>

    <form id="sendAdaForm">
        <div class="container">
            <div class="balance-card">
                <div class="league-spartan-regular">Available ADA Balance:</div>
                <div class="league-spartan-regular" id="adaBalance">₳ —</div>
            </div>
            <div class="input-group">
                <label for="amount">Ada:</label>
                <div class="input-icon-group">
                    <input type="number" id="amount" placeholder="₳  Enter amount" class="league-spartan-input" step="0.000001" min="0">
                </div>
            </div>
            <div class="input-group">
                <label for="recipient">Recipient Address:</label>
                <div class="input-icon-group">
                    <input type="text" id="recipient" placeholder="Enter recipient address" class="league-spartan-input">
                </div>
            </div>
            <div class="button-group">
                <button class="send-button league-spartan-send-button" type="submit">Send</button>
                <button class="reset-button league-spartan-reset-button" id="clearForm" type="button">Clear</button>
            </div>
            <div class="terms">
                Coxygen Global@2024 — Stokvel Escrow
            </div>
        </div>
    </form>
</div>
</body>
</html>
